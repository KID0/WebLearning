<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>贷款计算器</title>
</head>
<body>
	<table>
		<tr>
			<th>输入贷款数据</th>
			<td></td>
			<th>贷款平衡，累计权益，利润支出</th>
		</tr>
		<tr>
			<td>贷款总额($):</td>
			<td><input id="amount" onchange="calculate();"></input></td>
			<td rowspan="8"><canvas id="graph" width="400" height="250"></canvas></td>
		</tr>
		<tr>
			<td>年利润率(%)：</td>
			<td><input id="apr" onchange="calculate();"></input></td>
		</tr>
		<tr>
			<td>还款年限（年）：</td>
			<td><input id="years" onchange="calculate();"></input></td>
		</tr>
		<tr>
			<td>邮政编码：</td>
			<td><input id="zipcode" onchange="calculate();"></input></td>
		</tr>
		<tr>
			<td>支出项目</td>
			<td><button onclick="calculate();">计算</button></td>
		</tr>
		<tr>
			<td>每月支出：</td>
			<td>$<span class="output" id="payment"></span></td>
		</tr>
		<tr>
			<td>总支出：</td>
			<td>$<span class="output" id="total"></span></td>
		</tr>
		<tr>
			<td>总利润：</td>
			<td>$<span class="output" id="totalinterest"></span></td>
		</tr>
	</table>
	<script type="text/javascript">
		"use strict";
		function calculate() {
			//读取输入值,并计算，绘图
			var amount = document.getElementById('amount');
			var apr = document.getElementById("apr");
			var years = document.getElementById("years");
			var zipcode = document.getElementById("zipcode");
			var payment = document.getElementById("payment");
			var total = document.getElementById("total");
			var totalinterest = document.getElementById("totalinterest");
			//将年度赔付转换为月度赔付
			//parseFloat()：将字符串转换为数字，此处可不用
			var principal = parseFloat(amount.value);//贷款总额
			var interest = parseFloat(apr.value)/100/12;//月利率
			var payments = parseFloat(years.value)*12;//还款总月份
			//计算每月赔付金额
			var x = Math.pow(1 + interest,payments);//幂方运算
			var monthly = (principal * x * interest)/(x - 1);
			//确认输入数据合法
			if (isFinite(monthly)) {
				payment.innerHTML = monthly.toFixed(2);
				//toFixed(2)：四舍五入，保留小数后两位
				total.innerHTML = (monthly * payments).toFixed(2);
				totalinterest.innerHTML = ((monthly * payments) - principal).toFixed(2);
			
				//保存用户数据
				save(amount.value, apr.value, years.value, zipcode.value);

				try{//捕获代码异常
					getLenders(amount.value, apr.value, years.value, zipcode.value);
				}
				catch(e){/*忽略异常*/}
				//绘制图表
				chart(principal,interest,monthly,payments);
			} 
			else{
				//数据输入错误，清空数据
				payment.innerHTML = "";
				total.innerHTML = "";
				totalinterest.innerHTML = "";
				chart();
			}
		}
		function save(amount,apr,years,zipcode) {
			if (window.localStorage) {//如果浏览器支持localStorage方法的话
				localStorage.loan_amount = amount;
				localStorage.loan_apr = apr;
				localStorage.loan_years = years;
				localStorage.loan_zipcode = zipcode;
			} 
		}

		window.onload = function(){
			//如果浏览器支持该功能并且上次保存的值存在
			if (window.localStorage && localStorage.loan_amount) {
				document.getElementById("amount").value = localStorage.loan_amount;
				document.getElementById("apr").value = localStorage.loan_apr;
				document.getElementById("years").value = localStorage.loan_years;
				document.getElementById("zipcode").value = localStorage.loan_zipcode;
			}
		}

		//将用户输入发送到服务器
		//返回本地放贷人列表（如果有这种服务的话）
		function getLenders(amount,apr,years,zipcode) {
			//如果浏览器不支持XHR服务，退出
			if (!window.XMLHttpRequest) return;//
		}
	</script>
</body>
</html>